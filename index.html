<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Attività</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Gestore attività personali installabile e offline">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Task Manager">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.5;
        }

        body.dark {
            background-color: #111827;
            color: #f9fafb;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .dark .header {
            background: #1f2937;
            border-bottom-color: #374151;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-purple {
            background: #8b5cf6;
            color: white;
        }

        .btn-purple:hover {
            background: #7c3aed;
        }

        .btn-indigo {
            background: #6366f1;
            color: white;
        }

        .btn-indigo:hover {
            background: #4f46e5;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        /* Layout */
        .main-layout {
            display: flex;
            gap: 24px;
            padding: 24px 0;
        }

        .sidebar {
            width: 256px;
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
        }

        /* Sidebar */
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .dark .nav-item {
            background: #1f2937;
            border-color: #374151;
        }

        .nav-item:hover {
            background: #f3f4f6;
        }

        .dark .nav-item:hover {
            background: #374151;
        }

        .nav-item.active {
            background: #eff6ff;
            color: #1d4ed8;
            border-color: #93c5fd;
        }

        .nav-item .badge {
            margin-left: auto;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        /* Cards */
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark .card {
            background: #1f2937;
            border-color: #374151;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 16px;
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-2x2 {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* Overview specific styles */
        .overview-header {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            color: white;
            text-align: center;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .overview-header h2 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .overview-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .stat-card {
            text-align: center;
            padding: 12px;
            border-radius: 6px;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        .stat-blue { background: #dbeafe; }
        .stat-green { background: #d1fae5; }
        .stat-red { background: #fee2e2; }
        .stat-purple { background: #e9d5ff; }

        .stat-blue .stat-number { color: #1d4ed8; }
        .stat-green .stat-number { color: #047857; }
        .stat-red .stat-number { color: #dc2626; }
        .stat-purple .stat-number { color: #7c3aed; }

        /* Task items */
        .task-item {
            border-left: 4px solid;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .task-content {
            flex: 1;
        }

        .task-badges {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }

        .badge-high { background: #fee2e2; color: #991b1b; }
        .badge-medium { background: #fef3c7; color: #92400e; }
        .badge-low { background: #f3f4f6; color: #374151; }

        .task-title {
            font-weight: 500;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .task-details {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .task-actions {
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            padding: 4px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            color: #6b7280;
        }

        .icon-btn:hover {
            background: #f3f4f6;
        }

        .icon-btn.text-blue { color: #2563eb; }
        .icon-btn.text-green { color: #059669; }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dark .modal-content {
            background: #1f2937;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .color-option.selected {
            border-color: #111827;
        }

        /* GitHub Sync Banner */
        .github-banner {
            background: linear-gradient(to right, #6366f1, #8b5cf6);
            color: white;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 16px;
            position: relative;
        }

        .github-banner .close-banner {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.8;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .sync-connected {
            background: #d1fae5;
            color: #047857;
        }

        .sync-error {
            background: #fee2e2;
            color: #dc2626;
        }

        .sync-syncing {
            background: #fef3c7;
            color: #92400e;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .header-buttons {
                flex-wrap: wrap;
            }
        }

        /* Utilities */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .text-xs { font-size: 12px; }
        .text-sm { font-size: 14px; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: bold; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .space-y-2 > * + * { margin-top: 8px; }
        .space-y-3 > * + * { margin-top: 12px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .w-4 { width: 16px; height: 16px; }
        .w-5 { width: 20px; height: 20px; }
        .rounded-full { border-radius: 50%; }
        .truncate { 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <h1>Gestore Attività</h1>
                    <div class="header-buttons">
                        <div id="sync-status-indicator" class="sync-status hidden">
                            <!-- Status sincronizzazione -->
                        </div>
                        <button class="btn btn-primary" onclick="setView('overview')">
                            <span>👁️</span> Panoramica
                        </button>
                        <button class="btn btn-purple" onclick="showStats()">
                            <span>📊</span> Statistiche
                        </button>
                        <button class="btn btn-indigo" onclick="showCalendar()">
                            <span>📅</span> Calendario
                        </button>
                        <button class="btn btn-secondary" onclick="showSettings()">
                            <span>⚙️</span> Impostazioni
                        </button>
                        <button class="btn btn-success" onclick="showNewListForm()">
                            <span>➕</span> Nuovo Elenco
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- GitHub Setup Banner -->
        <div id="github-setup-banner" class="hidden">
            <div class="container">
                <div class="github-banner">
                    <button class="close-banner" onclick="dismissSetupBanner()">×</button>
                    <strong>🔄 Sincronizzazione Cloud</strong>
                    <p style="margin: 4px 0; font-size: 13px;">
                        Configura GitHub per sincronizzare i tuoi dati su tutti i dispositivi
                    </p>
                    <button class="btn btn-secondary" onclick="showGitHubSetup()" style="margin-top: 8px; font-size: 12px; padding: 6px 12px;">
                        ⚙️ Configura Ora
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <div class="main-layout">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <nav class="sidebar-nav" id="sidebar-nav">
                        <!-- Lista dinamica popolata da JS -->
                    </nav>
                </aside>

                <!-- Main Content -->
                <main class="main-content">
                    <div id="content-area">
                        <!-- Contenuto dinamico popolato da JS -->
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals placeholder -->
    <div id="modal-container"></div>

    <script>
        // Classe per gestire la sincronizzazione con GitHub
        class GitHubSync {
            constructor() {
                this.username = '';
                this.token = '';
                this.repo = '';
                this.branch = 'main';
                this.filename = 'taskmanager-data.json';
                this.isConfigured = false;
                this.lastSync = null;
                this.syncInterval = null;
                
                this.loadConfig();
                this.updateSyncStatus();
            }

            loadConfig() {
                try {
                    const config = JSON.parse(localStorage.getItem('github-config') || '{}');
                    this.username = config.username || '';
                    this.token = config.token || '';
                    this.repo = config.repo || '';
                    this.isConfigured = !!(this.username && this.token && this.repo);
                    this.lastSync = config.lastSync || null;
                    
                    console.log('🔧 Config GitHub caricata:', { 
                        username: this.username, 
                        repo: this.repo, 
                        configured: this.isConfigured 
                    });
                } catch (error) {
                    console.error('❌ Errore caricamento config GitHub:', error);
                }
            }

            saveConfig() {
                try {
                    const config = {
                        username: this.username,
                        token: this.token,
                        repo: this.repo,
                        lastSync: this.lastSync
                    };
                    localStorage.setItem('github-config', JSON.stringify(config));
                    console.log('✅ Config GitHub salvata');
                } catch (error) {
                    console.error('❌ Errore salvataggio config GitHub:', error);
                }
            }

            async configure(username, token, repo) {
                try {
                    this.username = username;
                    this.token = token;
                    this.repo = repo;
                    
                    // Test della connessione
                    console.log('🧪 Test connessione GitHub...');
                    const testResult = await this.testConnection();
                    
                    if (testResult.success) {
                        this.isConfigured = true;
                        this.saveConfig();
                        this.updateSyncStatus();
                        
                        // Crea il file iniziale se non esiste
                        await this.createInitialFile();
                        
                        // Avvia sincronizzazione automatica
                        this.startAutoSync();
                        
                        console.log('✅ GitHub configurato con successo');
                        return { success: true, message: 'Configurazione completata!' };
                    } else {
                        return { success: false, message: testResult.error };
                    }
                } catch (error) {
                    console.error('❌ Errore configurazione GitHub:', error);
                    return { success: false, message: 'Errore di configurazione: ' + error.message };
                }
            }

            async testConnection() {
                try {
                    const response = await fetch('https://api.github.com/repos/' + this.username + '/' + this.repo, {
                        headers: {
                            'Authorization': 'token ' + this.token,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        return { success: true };
                    } else if (response.status === 404) {
                        return { success: false, error: 'Repository non trovato. Verifica username e nome repository.' };
                    } else if (response.status === 401) {
                        return { success: false, error: 'Token non valido. Verifica le tue credenziali.' };
                    } else {
                        return { success: false, error: 'Errore HTTP ' + response.status };
                    }
                } catch (error) {
                    return { success: false, error: 'Errore di connessione: ' + error.message };
                }
            }

            async createInitialFile() {
                try {
                    // Controlla se il file esiste già
                    const existsResponse = await fetch(
                        'https://api.github.com/repos/' + this.username + '/' + this.repo + '/contents/' + this.filename,
                        {
                            headers: {
                                'Authorization': 'token ' + this.token,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (existsResponse.status === 404) {
                        // File non esiste, crealo con i dati correnti
                        console.log('📄 Creazione file iniziale su GitHub...');
                        
                        const content = btoa(JSON.stringify(appState, null, 2));
                        
                        const createResponse = await fetch(
                            'https://api.github.com/repos/' + this.username + '/' + this.repo + '/contents/' + this.filename,
                            {
                                method: 'PUT',
                                headers: {
                                    'Authorization': 'token ' + this.token,
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/vnd.github.v3+json'
                                },
                                body: JSON.stringify({
                                    message: 'Inizializzazione Task Manager - primo sync',
                                    content: content,
                                    branch: this.branch
                                })
                            }
                        );

                        if (createResponse.ok) {
                            this.lastSync = new Date().toISOString();
                            this.saveConfig();
                            console.log('✅ File iniziale creato su GitHub');
                        }
                    } else if (existsResponse.ok) {
                        console.log('📄 File già esistente su GitHub');
                    }
                } catch (error) {
                    console.error('❌ Errore creazione file iniziale:', error);
                }
            }

            async syncToCloud() {
                if (!this.isConfigured) return;

                try {
                    this.updateSyncStatus('syncing');
                    console.log('☁️ Sincronizzazione verso GitHub...');

                    // Ottieni informazioni del file corrente (per SHA)
                    const getResponse = await fetch(
                        'https://api.github.com/repos/' + this.username + '/' + this.repo + '/contents/' + this.filename,
                        {
                            headers: {
                                'Authorization': 'token ' + this.token,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    let sha = null;
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }

                    // Prepara i dati per il sync
                    const dataToSync = {
                        ...appState,
                        lastSync: new Date().toISOString(),
                        syncedFrom: 'web'
                    };

                    const content = btoa(JSON.stringify(dataToSync, null, 2));

                    // Aggiorna il file
                    const body = {
                        message: 'Task Manager sync - ' + new Date().toLocaleString('it-IT'),
                        content: content,
                        branch: this.branch
                    };

                    if (sha) {
                        body.sha = sha;
                    }

                    const updateResponse = await fetch(
                        'https://api.github.com/repos/' + this.username + '/' + this.repo + '/contents/' + this.filename,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': 'token ' + this.token,
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github.v3+json'
                            },
                            body: JSON.stringify(body)
                        }
                    );

                    if (updateResponse.ok) {
                        this.lastSync = new Date().toISOString();
                        this.saveConfig();
                        this.updateSyncStatus('connected');
                        console.log('✅ Sincronizzazione completata');
                        return { success: true };
                    } else {
                        throw new Error('HTTP ' + updateResponse.status);
                    }
                } catch (error) {
                    console.error('❌ Errore sincronizzazione:', error);
                    this.updateSyncStatus('error');
                    return { success: false, error: error.message };
                }
            }

            async loadFromCloud() {
                if (!this.isConfigured) return;

                try {
                    console.log('📥 Caricamento dati da GitHub...');
                    
                    const response = await fetch(
                        'https://api.github.com/repos/' + this.username + '/' + this.repo + '/contents/' + this.filename,
                        {
                            headers: {
                                'Authorization': 'token ' + this.token,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (response.ok) {
                        const fileData = await response.json();
                        const content = atob(fileData.content);
                        const cloudData = JSON.parse(content);

                        // Controlla se i dati cloud sono più recenti
                        const cloudSyncTime = new Date(cloudData.lastSync || 0);
                        const localSyncTime = new Date(this.lastSync || 0);

                        if (cloudSyncTime > localSyncTime || !this.lastSync) {
                            // Aggiorna i dati locali con quelli del cloud
                            Object.assign(appState, {
                                ...cloudData,
                                currentView: 'overview',
                                selectedList: null
                            });
                            
                            this.lastSync = cloudData.lastSync;
                            this.saveConfig();
                            saveData();
                            
                            console.log('✅ Dati aggiornati dal cloud');
                            render();
                            return { success: true, updated: true };
                        } else {
                            console.log('ℹ️ Dati locali già aggiornati');
                            return { success: true, updated: false };
                        }
                    } else if (response.status === 404) {
                        console.log('📄 File non trovato su GitHub, creazione...');
                        await this.createInitialFile();
                        return { success: true, updated: false };
                    } else {
                        throw new Error('HTTP ' + response.status);
                    }
                } catch (error) {
                    console.error('❌ Errore caricamento da cloud:', error);
                    this.updateSyncStatus('error');
                    return { success: false, error: error.message };
                }
            }

            startAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                // Sincronizza ogni 5 minuti
                this.syncInterval = setInterval(() => {
                    this.syncToCloud();
                }, 5 * 60 * 1000);

                console.log('🔄 Auto-sync avviato (ogni 5 minuti)');
            }

            stopAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                    console.log('⏹️ Auto-sync fermato');
                }
            }

            updateSyncStatus(status = null) {
                const indicator = document.getElementById('sync-status-indicator');
                
                if (!this.isConfigured) {
                    indicator.className = 'sync-status hidden';
                    return;
                }

                indicator.className = 'sync-status';
                
                if (status === 'syncing') {
                    indicator.className += ' sync-syncing';
                    indicator.innerHTML = '🔄 Sincronizzando...';
                } else if (status === 'error') {
                    indicator.className += ' sync-error';
                    indicator.innerHTML = '❌ Errore Sync';
                } else {
                    indicator.className += ' sync-connected';
                    const lastSyncText = this.lastSync ? 
                        ' (' + new Date(this.lastSync).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + ')' : 
                        '';
                    indicator.innerHTML = '✅ GitHub' + lastSyncText;
                }
            }

            showSetupBanner() {
                const banner = document.getElementById('github-setup-banner');
                banner.classList.remove('hidden');
            }

            hideSetupBanner() {
                const banner = document.getElementById('github-setup-banner');
                banner.classList.add('hidden');
            }

            disconnect() {
                this.username = '';
                this.token = '';
                this.repo = '';
                this.isConfigured = false;
                this.lastSync = null;
                
                this.stopAutoSync();
                localStorage.removeItem('github-config');
                this.updateSyncStatus();
                this.showSetupBanner();
                
                console.log('🔌 GitHub disconnesso');
            }
        }

        // Variabile globale per GitHub Sync
        let githubSync = null;

        // Dati dell'applicazione
        let appState = {
            theme: 'light',
            soundEnabled: true,
            selectedSound: 'ding',
            currentView: 'overview',
            selectedList: null,
            lists: [
                {
                    id: 1,
                    name: 'Lavoro',
                    color: '#3b82f6',
                    tasks: [
                        {
                            id: 1,
                            title: 'Preparare presentazione',
                            details: 'Slide per il meeting di venerdì',
                            completed: false,
                            reminder: '2025-07-07T14:00',
                            priority: 'high',
                            comments: [
                                { id: 1, text: 'Ricorda di includere i grafici Q2', time: '2025-07-06T10:30', author: 'Tu' }
                            ],
                            recurring: null,
                            timeSpent: 120,
                            createdAt: '2025-07-06T09:00'
                        },
                        {
                            id: 2,
                            title: 'Rispondere alle email',
                            details: 'Check inbox e risposte urgenti',
                            completed: false,
                            reminder: '',
                            priority: 'medium',
                            comments: [],
                            recurring: { type: 'daily', nextDue: '2025-07-08T09:00' },
                            timeSpent: 30,
                            createdAt: '2025-07-07T08:00'
                        }
                    ]
                },
                {
                    id: 2,
                    name: 'Casa',
                    color: '#10b981',
                    tasks: [
                        {
                            id: 3,
                            title: 'Spesa settimanale',
                            details: 'Latte, pane, verdure',
                            completed: false,
                            reminder: '2025-07-07T18:00',
                            priority: 'medium',
                            comments: [],
                            recurring: { type: 'weekly', nextDue: '2025-07-14T18:00' },
                            timeSpent: 45,
                            createdAt: '2025-07-07T08:00'
                        },
                        {
                            id: 4,
                            title: 'Pulire bagno',
                            details: '',
                            completed: true,
                            reminder: '',
                            priority: 'low',
                            comments: [],
                            recurring: null,
                            timeSpent: 60,
                            createdAt: '2025-07-06T14:00'
                        }
                    ]
                },
                {
                    id: 3,
                    name: 'Promemoria',
                    color: '#f59e0b',
                    tasks: [
                        {
                            id: 5,
                            title: 'Compleanno Marco',
                            details: 'Comprare regalo',
                            completed: false,
                            reminder: '2025-07-08T10:00',
                            priority: 'high',
                            comments: [
                                { id: 1, text: 'Gli piacciono i libri di fantascienza', time: '2025-07-06T15:00', author: 'Tu' }
                            ],
                            recurring: null,
                            timeSpent: 0,
                            createdAt: '2025-07-05T12:00'
                        }
                    ]
                }
            ],
            weather: {
                temp: 24,
                condition: 'Soleggiato',
                humidity: 65,
                wind: 12
            },
            news: [
                { id: 1, title: 'Mercati in crescita oggi', time: '2h fa' },
                { id: 2, title: 'Nuove tecnologie AI', time: '4h fa' },
                { id: 3, title: 'Eventi meteo della settimana', time: '6h fa' }
            ],
            calendarEvents: [
                { id: 1, title: 'Meeting Team', time: '14:00', date: '2025-07-07' },
                { id: 2, title: 'Dentista', time: '16:30', date: '2025-07-07' },
                { id: 3, title: 'Cena con amici', time: '20:00', date: '2025-07-08' }
            ],
            stats: {
                today: 3,
                week: 18,
                month: 72,
                streak: 5,
                totalCompleted: 147,
                productivity: 85,
                timeSpentToday: 245,
                avgTaskTime: 38
            }
        };

        // Utility functions
        function formatDateTime(date) {
            return date.toLocaleDateString('it-IT', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getUrgentTasks() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);

            return appState.lists.flatMap(list =>
                list.tasks
                    .filter(task => !task.completed)
                    .map(task => ({ ...task, listName: list.name, listColor: list.color, listId: list.id }))
                    .filter(task => {
                        if (task.priority === 'high') return true;
                        if (task.reminder) {
                            const reminderDate = new Date(task.reminder);
                            return reminderDate <= tomorrow;
                        }
                        return false;
                    })
            ).sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
        }

        function playSound() {
            if (!appState.soundEnabled || appState.selectedSound === 'none') return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const frequencies = {
                    ding: 800,
                    chime: 523,
                    bell: 440
                };
                
                oscillator.frequency.setValueAtTime(frequencies[appState.selectedSound] || 800, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // GitHub functions
        function showGitHubSetup() {
            showModal('Configurazione GitHub', `
                <div class="space-y-4">
                    <div class="card" style="background: #eff6ff; border-color: #93c5fd; padding: 12px;">
                        <h4 style="color: #1d4ed8; margin-bottom: 8px;">📋 Istruzioni Setup</h4>
                        <ol style="font-size: 13px; color: #1e40af; line-height: 1.4; margin-left: 16px;">
                            <li>Vai su <strong>GitHub.com</strong> e accedi</li>
                            <li>Crea un <strong>repository pubblico</strong> (es: "task-manager-data")</li>
                            <li>Vai su <strong>Settings > Developer settings > Personal access tokens > Tokens (classic)</strong></li>
                            <li>Clicca <strong>"Generate new token (classic)"</strong></li>
                            <li>Seleziona scopes: <strong>"repo"</strong> (Full repository access)</li>
                            <li>Copia il token generato</li>
                        </ol>
                    </div>

                    <form onsubmit="configureGitHub(event)">
                        <div class="form-group">
                            <label class="form-label">Username GitHub</label>
                            <input type="text" class="form-input" name="username" placeholder="il-tuo-username" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Nome Repository</label>
                            <input type="text" class="form-input" name="repo" placeholder="task-manager-data" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Token di Accesso</label>
                            <input type="password" class="form-input" name="token" placeholder="ghp_xxxxxxxxxxxxxxxx" required>
                            <small style="color: #6b7280; font-size: 12px;">Il token non verrà mai condiviso</small>
                        </div>
                        
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                🔗 Connetti GitHub
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">
                                Annulla
                            </button>
                        </div>
                    </form>
                </div>
            `);
        }

        async function configureGitHub(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const username = formData.get('username').trim();
            const repo = formData.get('repo').trim();
            const token = formData.get('token').trim();

            if (!username || !repo || !token) {
                alert('⚠️ Tutti i campi sono obbligatori');
                return;
            }

            // Mostra loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '🔄 Connessione...';
            submitBtn.disabled = true;

            try {
                const result = await githubSync.configure(username, token, repo);
                
                if (result.success) {
                    alert('✅ ' + result.message);
                    closeModal();
                    githubSync.hideSetupBanner();
                } else {
                    alert('❌ ' + result.message);
                }
            } catch (error) {
                alert('❌ Errore di configurazione: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function dismissSetupBanner() {
            githubSync.hideSetupBanner();
            localStorage.setItem('setupBannerDismissed', 'true');
        }

        async function manualSync() {
            if (!githubSync.isConfigured) {
                showGitHubSetup();
                return;
            }

            const result = await githubSync.syncToCloud();
            if (result.success) {
                alert('✅ Sincronizzazione completata!');
            } else {
                alert('❌ Errore sincronizzazione: ' + result.error);
            }
        }

        // Render functions
        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            nav.innerHTML = appState.lists.map(list => {
                const activeClass = appState.currentView === 'list' && appState.selectedList?.id === list.id ? 'active' : '';
                const incompleteTasks = list.tasks.filter(t => !t.completed).length;
                
                return `
                    <a href="#" class="nav-item ${activeClass}" onclick="setListView(${list.id})">
                        <div class="w-4 rounded-full" style="background-color: ${list.color}"></div>
                        <span class="font-medium">${list.name}</span>
                        <span class="badge">${incompleteTasks}</span>
                    </a>
                `;
            }).join('');
        }

        function renderOverview() {
            const urgentTasks = getUrgentTasks();
            const totalTasks = appState.lists.reduce((sum, list) => sum + list.tasks.filter(t => !t.completed).length, 0);
            const completedToday = appState.lists.reduce((sum, list) => sum + list.tasks.filter(t => t.completed).length, 0);

            return `
                <div>
                    <!-- Header compatto -->
                    <div class="overview-header">
                        <h2>Panoramica Giornaliera</h2>
                        <p>${formatDateTime(new Date())}</p>
                    </div>

                    <!-- Layout a 3 colonne -->
                    <div class="grid grid-3">
                        <!-- Colonna 1: Statistiche + Meteo -->
                        <div class="space-y-3">
                            <!-- Statistiche compatte -->
                            <div class="card">
                                <h3 class="font-semibold mb-3 text-center">Statistiche Rapide</h3>
                                <div class="grid-2x2">
                                    <div class="stat-card stat-blue">
                                        <div class="stat-number">${totalTasks}</div>
                                        <div class="stat-label">Attivi</div>
                                    </div>
                                    <div class="stat-card stat-green">
                                        <div class="stat-number">${completedToday}</div>
                                        <div class="stat-label">Completati</div>
                                    </div>
                                    <div class="stat-card stat-red">
                                        <div class="stat-number">${urgentTasks.length}</div>
                                        <div class="stat-label">Urgenti</div>
                                    </div>
                                    <div class="stat-card stat-purple">
                                        <div class="stat-number">${appState.stats.streak} 🔥</div>
                                        <div class="stat-label">Streak</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Widget Meteo compatto -->
                            <div class="card">
                                <div class="flex items-center gap-2 mb-3">
                                    <span>☁️</span>
                                    <span class="font-medium text-sm">Meteo</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold">${appState.weather.temp}°C</div>
                                        <div class="text-xs" style="color: #6b7280">${appState.weather.condition}</div>
                                    </div>
                                    <div class="text-xs space-y-1" style="text-align: right;">
                                        <div class="flex items-center gap-1">
                                            <span>🌡️</span>${appState.weather.humidity}%
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span>💨</span>${appState.weather.wind} km/h
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Colonna 2: Calendario + Produttività -->
                        <div class="space-y-3">
                            <!-- Eventi del giorno -->
                            <div class="card">
                                <div class="flex items-center gap-2 mb-3">
                                    <span>📅</span>
                                    <span class="font-medium text-sm">Oggi</span>
                                    <button class="icon-btn text-blue" onclick="showCalendar()" style="margin-left: auto;">
                                        👁️
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    ${appState.calendarEvents.slice(0, 4).map(event => `
                                        <div class="flex justify-between text-xs">
                                            <span class="truncate" style="padding-right: 8px;">${event.title}</span>
                                            <span style="color: #6b7280; flex-shrink: 0;">${event.time}</span>
                                        </div>
                                    `).join('')}
                                    ${appState.calendarEvents.length === 0 ? '<p class="text-xs text-center" style="color: #6b7280; padding: 8px 0;">Nessun evento</p>' : ''}
                                </div>
                            </div>

                            <!-- Produttività compatta -->
                            <div class="card">
                                <div class="flex items-center gap-2 mb-3">
                                    <span>📊</span>
                                    <span class="font-medium text-sm">Produttività</span>
                                    <button class="icon-btn text-green" onclick="showStats()" style="margin-left: auto;">
                                        👁️
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs">
                                        <span>Tempo oggi:</span>
                                        <span class="font-semibold">${Math.floor(appState.stats.timeSpentToday / 60)}h ${appState.stats.timeSpentToday % 60}m</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${appState.stats.productivity}%"></div>
                                    </div>
                                    <div class="text-xs text-center" style="color: #6b7280;">${appState.stats.productivity}% efficienza</div>
                                    <div class="text-xs text-center">
                                        <span style="color: #6b7280;">Media task: </span>
                                        <span class="font-semibold">${appState.stats.avgTaskTime}min</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Colonna 3: Notizie + Task Urgenti -->
                        <div class="space-y-3">
                            <!-- Notizie compatte -->
                            <div class="card">
                                <h3 class="font-medium mb-3 text-sm">Notizie</h3>
                                <div class="space-y-2">
                                    ${appState.news.slice(0, 4).map(item => `
                                        <div class="text-xs">
                                            <div class="font-medium truncate">${item.title}</div>
                                            <div style="color: #6b7280;">${item.time}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Task urgenti compatti -->
                            <div class="card">
                                <div class="flex items-center gap-2 mb-3">
                                    <span>⚠️</span>
                                    <span class="font-medium text-sm">Task Urgenti</span>
                                </div>
                                ${urgentTasks.length === 0 ? 
                                    '<p class="text-xs text-center" style="color: #6b7280; padding: 8px 0;">Tutto sotto controllo! 🎉</p>' :
                                    `<div class="space-y-2">
                                        ${urgentTasks.slice(0, 3).map(task => `
                                            <div class="task-item card" style="border-left-color: ${task.listColor}; padding: 8px; margin: 0;">
                                                <div class="flex items-center justify-between">
                                                    <div style="flex: 1; min-width: 0;">
                                                        <div class="flex items-center gap-1 mb-1">
                                                            <span class="badge text-xs" style="background-color: ${task.listColor}; color: white; padding: 1px 4px;">
                                                                ${task.listName}
                                                            </span>
                                                            <span class="badge badge-${task.priority} text-xs">
                                                                ${task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'Media' : 'Bassa'}
                                                            </span>
                                                        </div>
                                                        <h4 class="text-xs font-medium truncate">${task.title}</h4>
                                                        ${task.reminder ? `
                                                            <p class="text-xs flex items-center gap-1" style="color: #6b7280;">
                                                                <span>🔔</span>
                                                                ${new Date(task.reminder).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}
                                                            </p>
                                                        ` : ''}
                                                    </div>
                                                    <div class="flex gap-1" style="margin-left: 8px;">
                                                        ${task.comments && task.comments.length > 0 ? `
                                                            <button class="icon-btn text-blue" onclick="showTaskComments(${task.id})">
                                                                💬
                                                            </button>
                                                        ` : ''}
                                                        <button class="icon-btn text-green" onclick="toggleTask(${task.listId}, ${task.id})">
                                                            ⭕
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                        ${urgentTasks.length > 3 ? `
                                            <div class="text-xs text-center" style="color: #6b7280; padding-top: 4px;">
                                                +${urgentTasks.length - 3} altri task urgenti
                                            </div>
                                        ` : ''}
                                    </div>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderListView(list) {
            return `
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold flex items-center gap-2" style="font-size: 24px;">
                            <div class="w-5 rounded-full" style="background-color: ${list.color}"></div>
                            ${list.name}
                        </h2>
                        <button class="btn btn-primary" onclick="showNewTaskForm(${list.id})">
                            ➕ Nuovo Task
                        </button>
                    </div>

                    <div class="space-y-3">
                        ${list.tasks.map(task => `
                            <div class="card task-item ${task.completed ? 'opacity-60' : ''}" style="border-left-color: ${list.color}">
                                <div class="task-header">
                                    <div class="flex items-start gap-3" style="flex: 1;">
                                        <button class="icon-btn ${task.completed ? 'text-green' : ''}" onclick="toggleTask(${list.id}, ${task.id})" style="margin-top: 4px;">
                                            ${task.completed ? '✅' : '⭕'}
                                        </button>
                                        <div style="flex: 1;">
                                            <div class="flex items-center gap-2 mb-1">
                                                <h3 class="font-medium ${task.completed ? 'line-through' : ''}">${task.title}</h3>
                                                ${task.recurring ? `
                                                    <span class="badge" style="background: #e9d5ff; color: #7c3aed; font-size: 10px;">
                                                        🔄 ${task.recurring.type === 'daily' ? 'Giornaliero' : 'Settimanale'}
                                                    </span>
                                                ` : ''}
                                            </div>
                                            ${task.details ? `
                                                <p class="text-sm ${task.completed ? 'line-through' : ''}" style="color: #6b7280; margin-top: 4px;">${task.details}</p>
                                            ` : ''}
                                            ${task.reminder ? `
                                                <p class="text-xs flex items-center gap-1" style="color: #6b7280; margin-top: 4px;">
                                                    🔔 ${new Date(task.reminder).toLocaleString('it-IT')}
                                                </p>
                                            ` : ''}
                                            <div class="flex items-center gap-2" style="margin-top: 8px;">
                                                <span class="badge badge-${task.priority}">
                                                    ${task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'Media' : 'Bassa'}
                                                </span>
                                                ${task.timeSpent > 0 ? `
                                                    <span class="text-xs" style="color: #6b7280;">
                                                        ${Math.floor(task.timeSpent / 60)}h ${task.timeSpent % 60}m
                                                    </span>
                                                ` : ''}
                                                ${task.comments && task.comments.length > 0 ? `
                                                    <button class="text-xs icon-btn text-blue" onclick="showTaskComments(${task.id})">
                                                        💬 ${task.comments.length}
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="task-actions">
                                        <button class="icon-btn text-blue" onclick="showTaskComments(${task.id})">💬</button>
                                        <button class="icon-btn" style="color: #dc2626;" onclick="deleteTask(${list.id}, ${task.id})">❌</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${list.tasks.length === 0 ? `
                            <div class="card text-center" style="padding: 32px;">
                                <p style="color: #6b7280;">Nessun task in questa lista</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Event handlers
        function setView(view) {
            appState.currentView = view;
            appState.selectedList = null;
            render();
        }

        function setListView(listId) {
            const list = appState.lists.find(l => l.id === listId);
            appState.currentView = 'list';
            appState.selectedList = list;
            render();
        }

        function toggleTask(listId, taskId) {
            const list = appState.lists.find(l => l.id === listId);
            const task = list.tasks.find(t => t.id === taskId);
            task.completed = !task.completed;
            
            if (task.completed) {
                playSound();
                appState.stats.today++;
                appState.stats.totalCompleted++;
            }
            
            // 💾 SALVA LOCALE + CLOUD
            saveData();
            if (githubSync && githubSync.isConfigured) {
                githubSync.syncToCloud();
            }
            render();
        }

        function deleteTask(listId, taskId) {
            if (confirm('Sei sicuro di voler eliminare questo task?')) {
                const list = appState.lists.find(l => l.id === listId);
                list.tasks = list.tasks.filter(t => t.id !== taskId);
                
                // 💾 SALVA LOCALE + CLOUD
                saveData();
                if (githubSync && githubSync.isConfigured) {
                    githubSync.syncToCloud();
                }
                render();
            }
        }

        function showNewListForm() {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
            
            showModal('Nuovo Elenco', `
                <form onsubmit="createList(event)">
                    <div class="form-group">
                        <label class="form-label">Nome elenco</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Colore:</label>
                        <div class="color-picker">
                            ${colors.map((color, i) => `
                                <div class="color-option ${i === 0 ? 'selected' : ''}" 
                                     style="background-color: ${color}" 
                                     onclick="selectColor(this, '${color}')"
                                     data-color="${color}">
                                </div>
                            `).join('')}
                        </div>
                        <input type="hidden" name="color" value="${colors[0]}">
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Crea</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Annulla</button>
                    </div>
                </form>
            `);
        }

        function showNewTaskForm(listId) {
            showModal('Nuovo Task', `
                <form onsubmit="createTask(event, ${listId})">
                    <div class="form-group">
                        <label class="form-label">Titolo</label>
                        <input type="text" class="form-input" name="title" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dettagli (opzionale)</label>
                        <textarea class="form-textarea" name="details"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reminder</label>
                        <input type="datetime-local" class="form-input" name="reminder">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priorità</label>
                        <select class="form-select" name="priority">
                            <option value="low">Bassa priorità</option>
                            <option value="medium" selected>Media priorità</option>
                            <option value="high">Alta priorità</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ricorrenza</label>
                        <select class="form-select" name="recurring">
                            <option value="none">Nessuna</option>
                            <option value="daily">Giornaliera</option>
                            <option value="weekly">Settimanale</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Crea</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Annulla</button>
                    </div>
                </form>
            `);
        }

        function showStats() {
            showModal('Statistiche Produttività', `
                <div class="space-y-3">
                    <div class="grid-2x2">
                        <div class="stat-card stat-blue">
                            <div class="stat-number">${appState.stats.today}</div>
                            <div class="stat-label">Task Oggi</div>
                        </div>
                        <div class="stat-card stat-green">
                            <div class="stat-number">${appState.stats.week}</div>
                            <div class="stat-label">Settimana</div>
                        </div>
                        <div class="stat-card stat-purple">
                            <div class="stat-number">${appState.stats.month}</div>
                            <div class="stat-label">Mese</div>
                        </div>
                        <div class="stat-card" style="background: #fef3c7;">
                            <div class="stat-number" style="color: #92400e;">${appState.stats.streak}</div>
                            <div class="stat-label">Streak giorni</div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Produttività:</span>
                            <span class="font-semibold">${appState.stats.productivity}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${appState.stats.productivity}%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Tempo oggi:</span>
                            <span class="font-semibold">${Math.floor(appState.stats.timeSpentToday / 60)}h ${appState.stats.timeSpentToday % 60}m</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Tempo medio per task:</span>
                            <span class="font-semibold">${appState.stats.avgTaskTime} min</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Task completati totali:</span>
                            <span class="font-semibold">${appState.stats.totalCompleted}</span>
                        </div>
                    </div>
                </div>
            `);
        }

        function showCalendar() {
            showModal('Calendario Oggi', `
                <div class="space-y-3">
                    ${appState.calendarEvents.map(event => `
                        <div class="card">
                            <div class="flex items-center gap-2 mb-1">
                                <span>📅</span>
                                <span class="font-medium">${event.title}</span>
                            </div>
                            <div class="text-sm" style="color: #6b7280;">
                                ${event.time} - ${new Date(event.date).toLocaleDateString('it-IT')}
                            </div>
                        </div>
                    `).join('')}
                    
                    ${appState.calendarEvents.length === 0 ? '<p class="text-center" style="color: #6b7280; padding: 16px;">Nessun evento oggi</p>' : ''}
                </div>
            `);
        }

        function showSettings() {
            const syncStatus = githubSync && githubSync.isConfigured ? 
                `<div class="card" style="background: #d1fae5; border-color: #10b981; padding: 12px;">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 style="color: #047857; margin-bottom: 4px;">✅ GitHub Connesso</h4>
                            <p style="color: #059669; font-size: 12px;">Repository: ${githubSync.username}/${githubSync.repo}</p>
                            ${githubSync.lastSync ? `<p style="color: #059669; font-size: 12px;">Ultimo sync: ${new Date(githubSync.lastSync).toLocaleString('it-IT')}</p>` : ''}
                        </div>
                        <div class="flex gap-1">
                            <button class="btn btn-secondary" onclick="manualSync()" style="font-size: 12px; padding: 6px 12px;">
                                🔄 Sync
                            </button>
                            <button class="btn btn-warning" onclick="disconnectGitHub()" style="font-size: 12px; padding: 6px 12px;">
                                🔌 Disconnetti
                            </button>
                        </div>
                    </div>
                </div>` :
                `<div class="card" style="background: #fef3c7; border-color: #f59e0b; padding: 12px;">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 style="color: #92400e; margin-bottom: 4px;">⚠️ Sincronizzazione Offline</h4>
                            <p style="color: #d97706; font-size: 12px;">I dati sono salvati solo localmente</p>
                        </div>
                        <button class="btn btn-primary" onclick="showGitHubSetup()" style="font-size: 12px; padding: 6px 12px;">
                            🔗 Configura GitHub
                        </button>
                    </div>
                </div>`;

            showModal('Impostazioni', `
                <div class="space-y-4">
                    ${syncStatus}
                    
                    <div>
                        <label class="form-label">Tema</label>
                        <div class="flex gap-2">
                            <button class="btn ${appState.theme === 'light' ? 'btn-primary' : 'btn-secondary'}" onclick="setTheme('light')">
                                ☀️ Chiaro
                            </button>
                            <button class="btn ${appState.theme === 'dark' ? 'btn-primary' : 'btn-secondary'}" onclick="setTheme('dark')">
                                🌙 Scuro
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">Suoni</label>
                        <div class="flex items-center gap-2 mb-2">
                            <button class="btn ${appState.soundEnabled ? 'btn-success' : 'btn-secondary'}" onclick="toggleSound()">
                                ${appState.soundEnabled ? '🔊' : '🔇'} ${appState.soundEnabled ? 'Abilitati' : 'Disabilitati'}
                            </button>
                        </div>
                        
                        ${appState.soundEnabled ? `
                            <select class="form-select" onchange="setSoundType(this.value)">
                                <option value="ding" ${appState.selectedSound === 'ding' ? 'selected' : ''}>🔔 Ding</option>
                                <option value="chime" ${appState.selectedSound === 'chime' ? 'selected' : ''}>🎵 Chime</option>
                                <option value="bell" ${appState.selectedSound === 'bell' ? 'selected' : ''}>🔊 Bell</option>
                                <option value="none" ${appState.selectedSound === 'none' ? 'selected' : ''}>🔇 Silenzioso</option>
                            </select>
                        ` : ''}
                    </div>
                    
                    <button class="btn btn-primary" onclick="playSound()" style="width: 100%;">
                        🔊 Test Suono
                    </button>
                </div>
            `);
        }

        function disconnectGitHub() {
            if (confirm('Vuoi disconnettere GitHub? I dati rimarranno solo in locale.')) {
                githubSync.disconnect();
                showSettings(); // Refresh settings modal
            }
        }

        function showTaskComments(taskId) {
            // Find task across all lists
            let task = null;
            let listId = null;
            
            for (const list of appState.lists) {
                const foundTask = list.tasks.find(t => t.id === taskId);
                if (foundTask) {
                    task = foundTask;
                    listId = list.id;
                    break;
                }
            }
            
            if (!task) return;
            
            showModal(`Commenti - ${task.title}`, `
                <div class="space-y-3 mb-4" style="max-height: 200px; overflow-y: auto;">
                    ${task.comments.map(comment => `
                        <div class="card" style="background: #f3f4f6; padding: 12px;">
                            <div class="text-sm mb-1" style="color: #6b7280;">
                                ${comment.author} - ${new Date(comment.time).toLocaleString('it-IT')}
                            </div>
                            <div>${comment.text}</div>
                        </div>
                    `).join('')}
                    
                    ${task.comments.length === 0 ? '<p class="text-center" style="color: #6b7280; padding: 16px;">Nessun commento</p>' : ''}
                </div>
                
                <form onsubmit="addComment(event, ${listId}, ${taskId})">
                    <div class="flex gap-2">
                        <input type="text" class="form-input" name="comment" placeholder="Aggiungi commento..." required style="flex: 1;">
                        <button type="submit" class="btn btn-primary">Invia</button>
                    </div>
                </form>
            `);
        }

        // Modal functions
        function showModal(title, content) {
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${title}</h3>
                            <button class="close-btn" onclick="closeModal()">×</button>
                        </div>
                        ${content}
                    </div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // Form handlers
        function createList(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newList = {
                id: Date.now(),
                name: formData.get('name'),
                color: formData.get('color'),
                tasks: []
            };
            appState.lists.push(newList);
            playSound();
            
            // 💾 SALVA LOCALE + CLOUD
            saveData();
            if (githubSync && githubSync.isConfigured) {
                githubSync.syncToCloud();
            }
            closeModal();
            render();
        }

        function createTask(event, listId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newTask = {
                id: Date.now(),
                title: formData.get('title'),
                details: formData.get('details'),
                completed: false,
                reminder: formData.get('reminder'),
                priority: formData.get('priority'),
                comments: [],
                recurring: formData.get('recurring') !== 'none' ? { 
                    type: formData.get('recurring'), 
                    nextDue: formData.get('reminder') 
                } : null,
                timeSpent: 0,
                createdAt: new Date().toISOString()
            };
            
            const list = appState.lists.find(l => l.id === listId);
            list.tasks.push(newTask);
            playSound();
            
            // 💾 SALVA LOCALE + CLOUD
            saveData();
            if (githubSync && githubSync.isConfigured) {
                githubSync.syncToCloud();
            }
            closeModal();
            render();
        }

        function addComment(event, listId, taskId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const commentText = formData.get('comment');
            
            if (!commentText.trim()) return;
            
            const list = appState.lists.find(l => l.id === listId);
            const task = list.tasks.find(t => t.id === taskId);
            
            const newComment = {
                id: Date.now(),
                text: commentText,
                time: new Date().toISOString(),
                author: 'Tu'
            };
            
            task.comments.push(newComment);
            
            // 💾 SALVA LOCALE + CLOUD
            saveData();
            if (githubSync && githubSync.isConfigured) {
                githubSync.syncToCloud();
            }
            showTaskComments(taskId); // Refresh modal
        }

        function selectColor(element, color) {
            // Remove selected class from all color options
            element.parentElement.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            // Add selected class to clicked element
            element.classList.add('selected');
            // Update hidden input
            element.parentElement.parentElement.querySelector('input[name="color"]').value = color;
        }

        function setTheme(theme) {
            appState.theme = theme;
            document.body.className = theme === 'dark' ? 'dark' : '';
            
            // 💾 SALVA LOCALE + CLOUD
            saveData();
            if (githubSync && githubSync.isConfigured) {
                githubSync.syncToCloud();
            }
            if (document.querySelector('.modal')) {
                showSettings(); // Refresh settings modal
            }
        }

        function toggleSound() {
            appState.soundEnabled = !appState.soundEnabled;
            
            // 💾 SALVA LOCALE + CLOUD
            saveData();
            if (githubSync && githubSync.isConfigured) {
                githubSync.syncToCloud();
            }
            showSettings(); // Refresh settings modal
        }

        function setSoundType(soundType) {
            appState.selectedSound = soundType;
            
            // 💾 SALVA LOCALE + CLOUD
            saveData();
            if (githubSync && githubSync.isConfigured) {
                githubSync.syncToCloud();
            }
        }

        // Funzioni di salvataggio/caricamento
        function saveData() {
            try {
                localStorage.setItem('taskManagerData', JSON.stringify(appState));
                console.log('✅ Dati salvati in locale');
            } catch (error) {
                console.error('❌ Errore salvataggio:', error);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('taskManagerData');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Mantieni solo i dati, non sovrascrivere le funzioni
                    Object.assign(appState, {
                        ...data,
                        currentView: 'overview', // Reset view all'avvio
                        selectedList: null
                    });
                    console.log('✅ Dati caricati dal locale');
                    return true;
                }
            } catch (error) {
                console.error('❌ Errore caricamento:', error);
            }
            return false;
        }

        // Main render function
        function render() {
            renderSidebar();
            
            const contentArea = document.getElementById('content-area');
            
            if (appState.currentView === 'overview') {
                contentArea.innerHTML = renderOverview();
            } else if (appState.currentView === 'list' && appState.selectedList) {
                contentArea.innerHTML = renderListView(appState.selectedList);
            } else {
                contentArea.innerHTML = `
                    <div class="card text-center" style="padding: 48px;">
                        <p style="color: #6b7280;">Seleziona una lista o vai alla panoramica</p>
                    </div>
                `;
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4ge30pOyBzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4ge30pOw==')
                .then(() => console.log('SW registered'))
                .catch(() => console.log('SW registration failed'));
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Inizializzazione app...');
            
            // Inizializza GitHub Sync
            githubSync = new GitHubSync();
            
            // Carica dati salvati
            const dataLoaded = loadData();
            if (dataLoaded) {
                console.log('✅ Dati locali caricati');
            } else {
                console.log('🆕 Prima volta - usando dati predefiniti');
            }
            
            // Applica tema salvato
            if (appState.theme === 'dark') {
                document.body.className = 'dark';
            }
            
            // Gestisci banner setup
            const setupBannerDismissed = localStorage.getItem('setupBannerDismissed');
            if (setupBannerDismissed === 'true' || githubSync.isConfigured) {
                githubSync.hideSetupBanner();
            } else {
                githubSync.showSetupBanner();
            }
            
            // Carica dati da cloud se configurato
            if (githubSync.isConfigured) {
                githubSync.loadFromCloud();
                githubSync.startAutoSync();
            }
            
            // Prima render
            render();
            
            // Test localStorage
            console.log('🧪 Test localStorage...');
            try {
                localStorage.setItem('test', 'ok');
                localStorage.removeItem('test');
                console.log('✅ localStorage funziona');
            } catch (e) {
                console.error('❌ localStorage NON funziona:', e);
                alert('⚠️ LocalStorage non disponibile. I dati non verranno salvati.');
            }
            
            // Test GitHub Sync
            if (githubSync.isConfigured) {
                console.log('✅ GitHub Sync configurato');
            } else {
                console.log('🟡 GitHub Sync non configurato - solo salvataggio locale');
            }
        });
    </script>
</body>
</html>
                    