<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Attività - Modulare</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Gestore attività personali installabile e offline">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Task Manager">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.5;
        }

        body.dark {
            background-color: #111827;
            color: #f9fafb;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .dark .header {
            background: #1f2937;
            border-bottom-color: #374151;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: bold;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-purple {
            background: #8b5cf6;
            color: white;
        }

        .btn-purple:hover {
            background: #7c3aed;
        }

        .btn-indigo {
            background: #6366f1;
            color: white;
        }

        .btn-indigo:hover {
            background: #4f46e5;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        /* Layout */
        .main-layout {
            display: flex;
            gap: 24px;
            padding: 24px 0;
        }

        .sidebar {
            width: 256px;
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
        }

        /* Sidebar */
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .dark .nav-item {
            background: #1f2937;
            border-color: #374151;
        }

        .nav-item:hover {
            background: #f3f4f6;
        }

        .dark .nav-item:hover {
            background: #374151;
        }

        .nav-item.active {
            background: #eff6ff;
            color: #1d4ed8;
            border-color: #93c5fd;
        }

        .nav-item .badge {
            margin-left: auto;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        /* Cards */
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark .card {
            background: #1f2937;
            border-color: #374151;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 16px;
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-2x2 {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* Overview specific styles */
        .overview-header {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            color: white;
            text-align: center;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .overview-header h2 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .overview-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .stat-card {
            text-align: center;
            padding: 12px;
            border-radius: 6px;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        .stat-blue { background: #dbeafe; }
        .stat-green { background: #d1fae5; }
        .stat-red { background: #fee2e2; }
        .stat-purple { background: #e9d5ff; }

        .stat-blue .stat-number { color: #1d4ed8; }
        .stat-green .stat-number { color: #047857; }
        .stat-red .stat-number { color: #dc2626; }
        .stat-purple .stat-number { color: #7c3aed; }

        /* Task items */
        .task-item {
            border-left: 4px solid;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .task-content {
            flex: 1;
        }

        .task-badges {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }

        .badge-high { background: #fee2e2; color: #991b1b; }
        .badge-medium { background: #fef3c7; color: #92400e; }
        .badge-low { background: #f3f4f6; color: #374151; }

        .task-title {
            font-weight: 500;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .task-details {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .task-actions {
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            padding: 4px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            color: #6b7280;
        }

        .icon-btn:hover {
            background: #f3f4f6;
        }

        .icon-btn.text-blue { color: #2563eb; }
        .icon-btn.text-green { color: #059669; }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dark .modal-content {
            background: #1f2937;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .color-option.selected {
            border-color: #111827;
        }

        /* GitHub Sync Banner */
        .github-banner {
            background: linear-gradient(to right, #6366f1, #8b5cf6);
            color: white;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 16px;
            position: relative;
        }

        .github-banner .close-banner {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.8;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .sync-connected {
            background: #d1fae5;
            color: #047857;
        }

        .sync-error {
            background: #fee2e2;
            color: #dc2626;
        }

        .sync-syncing {
            background: #fef3c7;
            color: #92400e;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .header-buttons {
                flex-wrap: wrap;
            }
        }

        /* Utilities */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .text-xs { font-size: 12px; }
        .text-sm { font-size: 14px; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: bold; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .space-y-2 > * + * { margin-top: 8px; }
        .space-y-3 > * + * { margin-top: 12px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .w-4 { width: 16px; height: 16px; }
        .w-5 { width: 20px; height: 20px; }
        .rounded-full { border-radius: 50%; }
        .truncate { 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <h1>Gestore Attività</h1>
                    <div class="header-buttons">
                        <div id="sync-status-indicator" class="sync-status hidden" onclick="app.ui.handleSyncStatusClick()">
                            <!-- Status sincronizzazione -->
                        </div>
                        <button class="btn btn-primary" onclick="app.ui.setView('overview')">
                            <span>👁️</span> Panoramica
                        </button>
                        <button class="btn btn-purple" onclick="app.ui.showStats()">
                            <span>📊</span> Statistiche
                        </button>
                        <button class="btn btn-indigo" onclick="app.ui.showCalendar()">
                            <span>📅</span> Calendario
                        </button>
                        <button class="btn btn-secondary" onclick="app.ui.showSettings()">
                            <span>⚙️</span> Impostazioni
                        </button>
                        <button class="btn btn-success" onclick="app.ui.showNewListForm()">
                            <span>➕</span> Nuovo Elenco
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- GitHub Setup Banner -->
        <div id="github-setup-banner" class="hidden">
            <div class="container">
                <div class="github-banner">
                    <button class="close-banner" onclick="app.github.dismissSetupBanner()">×</button>
                    <strong>🔄 Sincronizzazione Cloud</strong>
                    <p style="margin: 4px 0; font-size: 13px;">
                        Configura GitHub per sincronizzare i tuoi dati su tutti i dispositivi
                    </p>
                    <button class="btn btn-secondary" onclick="app.ui.showGitHubSetup()" style="margin-top: 8px; font-size: 12px; padding: 6px 12px;">
                        ⚙️ Configura Ora
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <div class="main-layout">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <nav class="sidebar-nav" id="sidebar-nav">
                        <!-- Lista dinamica popolata da JS -->
                    </nav>
                </aside>

                <!-- Main Content -->
                <main class="main-content">
                    <div id="content-area">
                        <!-- Contenuto dinamico popolato da JS -->
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals placeholder -->
    <div id="modal-container"></div>

    <script type="module">
        // === MODULO DATA ===
        class DataManager {
            constructor() {
                this.state = {
                    theme: 'light',
                    soundEnabled: true,
                    selectedSound: 'ding',
                    currentView: 'overview',
                    selectedList: null,
                    lists: [
                        {
                            id: 1,
                            name: 'Lavoro',
                            color: '#3b82f6',
                            tasks: [
                                {
                                    id: 1,
                                    title: 'Preparare presentazione',
                                    details: 'Slide per il meeting di venerdì',
                                    completed: false,
                                    reminder: '2025-07-07T14:00',
                                    priority: 'high',
                                    comments: [
                                        { id: 1, text: 'Ricorda di includere i grafici Q2', time: '2025-07-06T10:30', author: 'Tu' }
                                    ],
                                    recurring: null,
                                    timeSpent: 120,
                                    createdAt: '2025-07-06T09:00'
                                }
                            ]
                        },
                        {
                            id: 2,
                            name: 'Casa',
                            color: '#10b981',
                            tasks: [
                                {
                                    id: 3,
                                    title: 'Spesa settimanale',
                                    details: 'Latte, pane, verdure',
                                    completed: false,
                                    reminder: '2025-07-07T18:00',
                                    priority: 'medium',
                                    comments: [],
                                    recurring: { type: 'weekly', nextDue: '2025-07-14T18:00' },
                                    timeSpent: 45,
                                    createdAt: '2025-07-07T08:00'
                                }
                            ]
                        }
                    ],
                    weather: {
                        temp: 24,
                        condition: 'Soleggiato',
                        humidity: 65,
                        wind: 12
                    },
                    news: [
                        { id: 1, title: 'Mercati in crescita oggi', time: '2h fa' },
                        { id: 2, title: 'Nuove tecnologie AI', time: '4h fa' }
                    ],
                    calendarEvents: [
                        { id: 1, title: 'Meeting Team', time: '14:00', date: '2025-07-07' }
                    ],
                    stats: {
                        today: 3,
                        week: 18,
                        month: 72,
                        streak: 5,
                        totalCompleted: 147,
                        productivity: 85,
                        timeSpentToday: 245,
                        avgTaskTime: 38
                    }
                };
            }

            saveToLocal() {
                try {
                    localStorage.setItem('taskManagerData', JSON.stringify(this.state));
                    console.log('✅ Dati salvati in locale');
                } catch (error) {
                    console.error('❌ Errore salvataggio:', error);
                }
            }

            loadFromLocal() {
                try {
                    const saved = localStorage.getItem('taskManagerData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        Object.assign(this.state, {
                            ...data,
                            currentView: 'overview',
                            selectedList: null
                        });
                        console.log('✅ Dati caricati dal locale');
                        return true;
                    }
                } catch (error) {
                    console.error('❌ Errore caricamento:', error);
                }
                return false;
            }

            getUrgentTasks() {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);

                return this.state.lists.flatMap(list =>
                    list.tasks
                        .filter(task => !task.completed)
                        .map(task => ({ ...task, listName: list.name, listColor: list.color, listId: list.id }))
                        .filter(task => {
                            if (task.priority === 'high') return true;
                            if (task.reminder) {
                                const reminderDate = new Date(task.reminder);
                                return reminderDate <= tomorrow;
                            }
                            return false;
                        })
                ).sort((a, b) => {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                });
            }

            toggleTask(listId, taskId) {
                const list = this.state.lists.find(l => l.id === listId);
                const task = list.tasks.find(t => t.id === taskId);
                task.completed = !task.completed;
                
                if (task.completed) {
                    app.utils.playSound();
                    this.state.stats.today++;
                    this.state.stats.totalCompleted++;
                }
                
                this.saveAndSync();
            }

            deleteTask(listId, taskId) {
                const list = this.state.lists.find(l => l.id === listId);
                list.tasks = list.tasks.filter(t => t.id !== taskId);
                this.saveAndSync();
            }

            createList(name, color) {
                const newList = {
                    id: Date.now(),
                    name,
                    color,
                    tasks: []
                };
                this.state.lists.push(newList);
                app.utils.playSound();
                this.saveAndSync();
            }

            createTask(listId, taskData) {
                const newTask = {
                    id: Date.now(),
                    ...taskData,
                    completed: false,
                    comments: [],
                    timeSpent: 0,
                    createdAt: new Date().toISOString()
                };
                
                const list = this.state.lists.find(l => l.id === listId);
                list.tasks.push(newTask);
                app.utils.playSound();
                this.saveAndSync();
            }

            addComment(listId, taskId, commentText) {
                const list = this.state.lists.find(l => l.id === listId);
                const task = list.tasks.find(t => t.id === taskId);
                
                const newComment = {
                    id: Date.now(),
                    text: commentText,
                    time: new Date().toISOString(),
                    author: 'Tu'
                };
                
                task.comments.push(newComment);
                this.saveAndSync();
            }

            saveAndSync() {
                this.saveToLocal();
                
                if (app.github.isConfigured && !app.github.isSyncing) {
                    clearTimeout(window.syncTimeout);
                    window.syncTimeout = setTimeout(() => {
                        app.github.syncToCloud(false);
                    }, 2000);
                }
            }
        }

        // === MODULO GITHUB ===
        class GitHubSync {
            constructor() {
                this.username = '';
                this.token = '';
                this.repo = '';
                this.branch = 'main';
                this.filename = 'taskmanager-data.json';
                this.isConfigured = false;
                this.lastSync = null;
                this.syncInterval = null;
                this.isSyncing = false;
                
                this.loadConfig();
                this.updateSyncStatus();
            }

            loadConfig() {
                try {
                    const config = JSON.parse(localStorage.getItem('github-config') || '{}');
                    this.username = config.username || '';
                    this.token = config.token || '';
                    this.repo = config.repo || '';
                    this.isConfigured = !!(this.username && this.token && this.repo);
                    this.lastSync = config.lastSync || null;
                    
                    console.log('🔧 Config GitHub caricata:', { 
                        username: this.username, 
                        repo: this.repo, 
                        configured: this.isConfigured 
                    });
                } catch (error) {
                    console.error('❌ Errore caricamento config GitHub:', error);
                }
            }

            saveConfig() {
                try {
                    const config = {
                        username: this.username,
                        token: this.token,
                        repo: this.repo,
                        lastSync: this.lastSync
                    };
                    localStorage.setItem('github-config', JSON.stringify(config));
                    console.log('✅ Config GitHub salvata');
                } catch (error) {
                    console.error('❌ Errore salvataggio config GitHub:', error);
                }
            }

            async configure(username, token, repo) {
                try {
                    this.username = username;
                    this.token = token;
                    this.repo = repo;
                    
                    console.log('🧪 Test connessione GitHub...');
                    const testResult = await this.testConnection();
                    
                    if (testResult.success) {
                        this.isConfigured = true;
                        this.saveConfig();
                        this.updateSyncStatus();
                        
                        await this.createInitialFile();
                        this.startAutoSync();
                        
                        console.log('✅ GitHub configurato con successo');
                        return { success: true, message: 'Configurazione completata!' };
                    } else {
                        return { success: false, message: testResult.error };
                    }
                } catch (error) {
                    console.error('❌ Errore configurazione GitHub:', error);
                    return { success: false, message: 'Errore di configurazione: ' + error.message };
                }
            }

            async testConnection() {
                try {
                    const response = await fetch(`https://api.github.com/repos/${this.username}/${this.repo}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        return { success: true };
                    } else if (response.status === 404) {
                        return { success: false, error: 'Repository non trovato. Verifica username e nome repository.' };
                    } else if (response.status === 401) {
                        return { success: false, error: 'Token non valido. Verifica le tue credenziali.' };
                    } else {
                        return { success: false, error: 'Errore HTTP ' + response.status };
                    }
                } catch (error) {
                    return { success: false, error: 'Errore di connessione: ' + error.message };
                }
            }

            async syncToCloud(showFeedback = true) {
                if (!this.isConfigured || this.isSyncing) return;

                try {
                    this.isSyncing = true;
                    
                    if (showFeedback) {
                        this.updateSyncStatus('syncing');
                    }
                    
                    console.log('☁️ Sincronizzazione verso GitHub...');

                    // Get current file SHA
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${this.username}/${this.repo}/contents/${this.filename}`,
                        {
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    let sha = null;
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }

                    // Prepare data for sync
                    const dataToSync = {
                        ...app.data.state,
                        lastSync: new Date().toISOString(),
                        syncedFrom: 'web'
                    };

                    const content = btoa(JSON.stringify(dataToSync, null, 2));

                    const body = {
                        message: 'Task Manager sync - ' + new Date().toLocaleString('it-IT'),
                        content: content,
                        branch: this.branch
                    };

                    if (sha) {
                        body.sha = sha;
                    }

                    const updateResponse = await fetch(
                        `https://api.github.com/repos/${this.username}/${this.repo}/contents/${this.filename}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github.v3+json'
                            },
                            body: JSON.stringify(body)
                        }
                    );

                    if (updateResponse.ok) {
                        this.lastSync = new Date().toISOString();
                        this.saveConfig();
                        this.updateSyncStatus('connected');
                        console.log('✅ Sincronizzazione completata');
                        
                        if (showFeedback) {
                            this.showNotification('✅ Sincronizzato con GitHub!', 'success');
                        }
                        
                        return { success: true };
                    } else {
                        throw new Error('HTTP ' + updateResponse.status);
                    }
                } catch (error) {
                    console.error('❌ Errore sincronizzazione:', error);
                    this.updateSyncStatus('error');
                    
                    if (showFeedback) {
                        this.showNotification('❌ Errore sync: ' + error.message, 'error');
                    }
                    
                    return { success: false, error: error.message };
                } finally {
                    this.isSyncing = false;
                }
            }

            async loadFromCloud(showFeedback = true) {
                if (!this.isConfigured || this.isSyncing) return;

                try {
                    this.isSyncing = true;
                    
                    if (showFeedback) {
                        this.updateSyncStatus('syncing');
                    }
                    
                    console.log('📥 Caricamento dati da GitHub...');
                    
                    const response = await fetch(
                        `https://api.github.com/repos/${this.username}/${this.repo}/contents/${this.filename}`,
                        {
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (response.ok) {
                        const fileData = await response.json();
                        const content = atob(fileData.content);
                        const cloudData = JSON.parse(content);
                        
                        const cloudSyncTime = new Date(cloudData.lastSync || 0);
                        const localSyncTime = new Date(this.lastSync || 0);

                        if (cloudSyncTime > localSyncTime || !this.lastSync) {
                            Object.assign(app.data.state, {
                                ...cloudData,
                                currentView: 'overview',
                                selectedList: null
                            });
                            
                            this.lastSync = cloudData.lastSync;
                            this.saveConfig();
                            app.data.saveToLocal();
                            
                            console.log('✅ Dati aggiornati dal cloud');
                            app.ui.render();
                            
                            if (showFeedback) {
                                this.showNotification('📥 Dati aggiornati dal cloud!', 'success');
                            }
                            
                            this.updateSyncStatus('connected');
                            return { success: true, updated: true };
                        } else {
                            console.log('ℹ️ Dati locali già aggiornati');
                            this.updateSyncStatus('connected');
                            
                            if (showFeedback) {
                                this.showNotification('ℹ️ Dati già aggiornati', 'info');
                            }
                            
                            return { success: true, updated: false };
                        }
                    } else {
                        console.log('📄 File non trovato su GitHub');
                        await this.createInitialFile();
                        this.updateSyncStatus('connected');
                        return { success: true, updated: false };
                    }
                } catch (error) {
                    console.error('❌ Errore caricamento da cloud:', error);
                    this.updateSyncStatus('error');
                    
                    if (showFeedback) {
                        this.showNotification('❌ Errore caricamento: ' + error.message, 'error');
                    }
                    
                    return { success: false, error: error.message };
                } finally {
                    this.isSyncing = false;
                }
            }

            async createInitialFile() {
                try {
                    const content = btoa(JSON.stringify(app.data.state, null, 2));
                    
                    const createResponse = await fetch(
                        `https://api.github.com/repos/${this.username}/${this.repo}/contents/${this.filename}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/vnd.github.v3+json'
                            },
                            body: JSON.stringify({
                                message: 'Inizializzazione Task Manager - primo sync',
                                content: content,
                                branch: this.branch
                            })
                        }
                    );

                    if (createResponse.ok) {
                        this.lastSync = new Date().toISOString();
                        this.saveConfig();
                        console.log('✅ File iniziale creato su GitHub');
                    }
                } catch (error) {
                    console.error('❌ Errore creazione file iniziale:', error);
                }
            }

            showNotification(message, type = 'info') {
                const existing = document.querySelector('.sync-notification');
                if (existing) {
                    existing.remove();
                }
                
                const notification = document.createElement('div');
                notification.className = 'sync-notification';
                notification.textContent = message;
                
                const styles = {
                    success: 'background: #d1fae5; color: #047857; border: 1px solid #10b981;',
                    error: 'background: #fee2e2; color: #dc2626; border: 1px solid #ef4444;',
                    info: 'background: #dbeafe; color: #1d4ed8; border: 1px solid #3b82f6;'
                };
                
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 12px 16px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    animation: slideIn 0.3s ease-out;
                    ${styles[type] || styles.info}
                `;
                
                if (!document.querySelector('#sync-notification-styles')) {
                    const styleSheet = document.createElement('style');
                    styleSheet.id = 'sync-notification-styles';
                    styleSheet.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(styleSheet);
                }
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
            }

            startAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                this.syncInterval = setInterval(() => {
                    this.syncToCloud(false);
                }, 10 * 60 * 1000);

                console.log('🔄 Auto-sync avviato (ogni 10 minuti)');
            }

            updateSyncStatus(status = null) {
                const indicator = document.getElementById('sync-status-indicator');
                
                if (!this.isConfigured) {
                    indicator.className = 'sync-status hidden';
                    return;
                }

                indicator.className = 'sync-status';
                
                if (status === 'syncing') {
                    indicator.className += ' sync-syncing';
                    indicator.innerHTML = '🔄 Sincronizzando...';
                } else if (status === 'error') {
                    indicator.className += ' sync-error';
                    indicator.innerHTML = '❌ Errore Sync';
                } else {
                    indicator.className += ' sync-connected';
                    const lastSyncText = this.lastSync ? 
                        ' (' + new Date(this.lastSync).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + ')' : 
                        '';
                    indicator.innerHTML = '✅ GitHub' + lastSyncText;
                }
            }

            showSetupBanner() {
                const banner = document.getElementById('github-setup-banner');
                banner.classList.remove('hidden');
            }

            hideSetupBanner() {
                const banner = document.getElementById('github-setup-banner');
                banner.classList.add('hidden');
            }

            dismissSetupBanner() {
                this.hideSetupBanner();
                localStorage.setItem('setupBannerDismissed', 'true');
            }

            disconnect() {
                this.username = '';
                this.token = '';
                this.repo = '';
                this.isConfigured = false;
                this.lastSync = null;
                
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
                
                localStorage.removeItem('github-config');
                this.updateSyncStatus();
                this.showSetupBanner();
                
                console.log('🔌 GitHub disconnesso');
            }
        }

        // === MODULO UI ===
        class UIManager {
            constructor() {
                this.modal = null;
            }

            formatDateTime(date) {
                return date.toLocaleDateString('it-IT', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            setView(view) {
                app.data.state.currentView = view;
                app.data.state.selectedList = null;
                this.render();
            }

            setListView(listId) {
                const list = app.data.state.lists.find(l => l.id === listId);
                app.data.state.currentView = 'list';
                app.data.state.selectedList = list;
                this.render();
            }

            renderSidebar() {
                const nav = document.getElementById('sidebar-nav');
                nav.innerHTML = app.data.state.lists.map(list => {
                    const activeClass = app.data.state.currentView === 'list' && app.data.state.selectedList?.id === list.id ? 'active' : '';
                    const incompleteTasks = list.tasks.filter(t => !t.completed).length;
                    
                    return `
                        <a href="#" class="nav-item ${activeClass}" onclick="app.ui.setListView(${list.id})">
                            <div class="w-4 rounded-full" style="background-color: ${list.color}"></div>
                            <span class="font-medium">${list.name}</span>
                            <span class="badge">${incompleteTasks}</span>
                        </a>
                    `;
                }).join('');
            }

            renderOverview() {
                const urgentTasks = app.data.getUrgentTasks();
                const totalTasks = app.data.state.lists.reduce((sum, list) => sum + list.tasks.filter(t => !t.completed).length, 0);
                const completedToday = app.data.state.lists.reduce((sum, list) => sum + list.tasks.filter(t => t.completed).length, 0);

                return `
                    <div>
                        <div class="overview-header">
                            <h2>Panoramica Giornaliera</h2>
                            <p>${this.formatDateTime(new Date())}</p>
                        </div>

                        <div class="grid grid-3">
                            <div class="space-y-3">
                                <div class="card">
                                    <h3 class="font-semibold mb-3 text-center">Statistiche Rapide</h3>
                                    <div class="grid-2x2">
                                        <div class="stat-card stat-blue">
                                            <div class="stat-number">${totalTasks}</div>
                                            <div class="stat-label">Attivi</div>
                                        </div>
                                        <div class="stat-card stat-green">
                                            <div class="stat-number">${completedToday}</div>
                                            <div class="stat-label">Completati</div>
                                        </div>
                                        <div class="stat-card stat-red">
                                            <div class="stat-number">${urgentTasks.length}</div>
                                            <div class="stat-label">Urgenti</div>
                                        </div>
                                        <div class="stat-card stat-purple">
                                            <div class="stat-number">${app.data.state.stats.streak} 🔥</div>
                                            <div class="stat-label">Streak</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span>☁️</span>
                                        <span class="font-medium text-sm">Meteo</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold">${app.data.state.weather.temp}°C</div>
                                            <div class="text-xs" style="color: #6b7280">${app.data.state.weather.condition}</div>
                                        </div>
                                        <div class="text-xs space-y-1" style="text-align: right;">
                                            <div class="flex items-center gap-1">
                                                <span>🌡️</span>${app.data.state.weather.humidity}%
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span>💨</span>${app.data.state.weather.wind} km/h
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <div class="card">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span>📅</span>
                                        <span class="font-medium text-sm">Oggi</span>
                                        <button class="icon-btn text-blue" onclick="app.ui.showCalendar()" style="margin-left: auto;">
                                            👁️
                                        </button>
                                    </div>
                                    <div class="space-y-2">
                                        ${app.data.state.calendarEvents.slice(0, 4).map(event => `
                                            <div class="flex justify-between text-xs">
                                                <span class="truncate" style="padding-right: 8px;">${event.title}</span>
                                                <span style="color: #6b7280; flex-shrink: 0;">${event.time}</span>
                                            </div>
                                        `).join('')}
                                        ${app.data.state.calendarEvents.length === 0 ? '<p class="text-xs text-center" style="color: #6b7280; padding: 8px 0;">Nessun evento</p>' : ''}
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span>📊</span>
                                        <span class="font-medium text-sm">Produttività</span>
                                        <button class="icon-btn text-green" onclick="app.ui.showStats()" style="margin-left: auto;">
                                            👁️
                                        </button>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-xs">
                                            <span>Tempo oggi:</span>
                                            <span class="font-semibold">${Math.floor(app.data.state.stats.timeSpentToday / 60)}h ${app.data.state.stats.timeSpentToday % 60}m</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${app.data.state.stats.productivity}%"></div>
                                        </div>
                                        <div class="text-xs text-center" style="color: #6b7280;">${app.data.state.stats.productivity}% efficienza</div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <div class="card">
                                    <h3 class="font-medium mb-3 text-sm">Notizie</h3>
                                    <div class="space-y-2">
                                        ${app.data.state.news.slice(0, 4).map(item => `
                                            <div class="text-xs">
                                                <div class="font-medium truncate">${item.title}</div>
                                                <div style="color: #6b7280;">${item.time}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span>⚠️</span>
                                        <span class="font-medium text-sm">Task Urgenti</span>
                                    </div>
                                    ${urgentTasks.length === 0 ? 
                                        '<p class="text-xs text-center" style="color: #6b7280; padding: 8px 0;">Tutto sotto controllo! 🎉</p>' :
                                        `<div class="space-y-2">
                                            ${urgentTasks.slice(0, 3).map(task => `
                                                <div class="task-item card" style="border-left-color: ${task.listColor}; padding: 8px; margin: 0;">
                                                    <div class="flex items-center justify-between">
                                                        <div style="flex: 1; min-width: 0;">
                                                            <div class="flex items-center gap-1 mb-1">
                                                                <span class="badge text-xs" style="background-color: ${task.listColor}; color: white; padding: 1px 4px;">
                                                                    ${task.listName}
                                                                </span>
                                                                <span class="badge badge-${task.priority} text-xs">
                                                                    ${task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'Media' : 'Bassa'}
                                                                </span>
                                                            </div>
                                                            <h4 class="text-xs font-medium truncate">${task.title}</h4>
                                                            ${task.reminder ? `
                                                                <p class="text-xs flex items-center gap-1" style="color: #6b7280;">
                                                                    <span>🔔</span>
                                                                    ${new Date(task.reminder).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}
                                                                </p>
                                                            ` : ''}
                                                        </div>
                                                        <div class="flex gap-1" style="margin-left: 8px;">
                                                            ${task.comments && task.comments.length > 0 ? `
                                                                <button class="icon-btn text-blue" onclick="app.ui.showTaskComments(${task.id})">
                                                                    💬
                                                                </button>
                                                            ` : ''}
                                                            <button class="icon-btn text-green" onclick="app.data.toggleTask(${task.listId}, ${task.id}); app.ui.render();">
                                                                ⭕
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderListView(list) {
                return `
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="font-bold flex items-center gap-2" style="font-size: 24px;">
                                <div class="w-5 rounded-full" style="background-color: ${list.color}"></div>
                                ${list.name}
                            </h2>
                            <button class="btn btn-primary" onclick="app.ui.showNewTaskForm(${list.id})">
                                ➕ Nuovo Task
                            </button>
                        </div>

                        <div class="space-y-3">
                            ${list.tasks.map(task => `
                                <div class="card task-item ${task.completed ? 'opacity-60' : ''}" style="border-left-color: ${list.color}">
                                    <div class="task-header">
                                        <div class="flex items-start gap-3" style="flex: 1;">
                                            <button class="icon-btn ${task.completed ? 'text-green' : ''}" onclick="app.data.toggleTask(${list.id}, ${task.id}); app.ui.render();" style="margin-top: 4px;">
                                                ${task.completed ? '✅' : '⭕'}
                                            </button>
                                            <div style="flex: 1;">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <h3 class="font-medium ${task.completed ? 'line-through' : ''}">${task.title}</h3>
                                                    ${task.recurring ? `
                                                        <span class="badge" style="background: #e9d5ff; color: #7c3aed; font-size: 10px;">
                                                            🔄 ${task.recurring.type === 'daily' ? 'Giornaliero' : 'Settimanale'}
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                ${task.details ? `
                                                    <p class="text-sm ${task.completed ? 'line-through' : ''}" style="color: #6b7280; margin-top: 4px;">${task.details}</p>
                                                ` : ''}
                                                ${task.reminder ? `
                                                    <p class="text-xs flex items-center gap-1" style="color: #6b7280; margin-top: 4px;">
                                                        🔔 ${new Date(task.reminder).toLocaleString('it-IT')}
                                                    </p>
                                                ` : ''}
                                                <div class="flex items-center gap-2" style="margin-top: 8px;">
                                                    <span class="badge badge-${task.priority}">
                                                        ${task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'Media' : 'Bassa'}
                                                    </span>
                                                    ${task.timeSpent > 0 ? `
                                                        <span class="text-xs" style="color: #6b7280;">
                                                            ${Math.floor(task.timeSpent / 60)}h ${task.timeSpent % 60}m
                                                        </span>
                                                    ` : ''}
                                                    ${task.comments && task.comments.length > 0 ? `
                                                        <button class="text-xs icon-btn text-blue" onclick="app.ui.showTaskComments(${task.id})">
                                                            💬 ${task.comments.length}
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="task-actions">
                                            <button class="icon-btn text-blue" onclick="app.ui.showTaskComments(${task.id})">💬</button>
                                            <button class="icon-btn" style="color: #dc2626;" onclick="if(confirm('Sei sicuro di voler eliminare questo task?')) { app.data.deleteTask(${list.id}, ${task.id}); app.ui.render(); }">❌</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${list.tasks.length === 0 ? `
                                <div class="card text-center" style="padding: 32px;">
                                    <p style="color: #6b7280;">Nessun task in questa lista</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            render() {
                this.renderSidebar();
                
                const contentArea = document.getElementById('content-area');
                
                if (app.data.state.currentView === 'overview') {
                    contentArea.innerHTML = this.renderOverview();
                } else if (app.data.state.currentView === 'list' && app.data.state.selectedList) {
                    contentArea.innerHTML = this.renderListView(app.data.state.selectedList);
                } else {
                    contentArea.innerHTML = `
                        <div class="card text-center" style="padding: 48px;">
                            <p style="color: #6b7280;">Seleziona una lista o vai alla panoramica</p>
                        </div>
                    `;
                }
            }

            showModal(title, content) {
                document.getElementById('modal-container').innerHTML = `
                    <div class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>${title}</h3>
                                <button class="close-btn" onclick="app.ui.closeModal()">×</button>
                            </div>
                            ${content}
                        </div>
                    </div>
                `;
            }

            closeModal() {
                document.getElementById('modal-container').innerHTML = '';
            }

            showNewListForm() {
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
                
                this.showModal('Nuovo Elenco', `
                    <form onsubmit="app.ui.handleCreateList(event)">
                        <div class="form-group">
                            <label class="form-label">Nome elenco</label>
                            <input type="text" class="form-input" name="name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Colore:</label>
                            <div class="color-picker">
                                ${colors.map((color, i) => `
                                    <div class="color-option ${i === 0 ? 'selected' : ''}" 
                                         style="background-color: ${color}" 
                                         onclick="app.ui.selectColor(this, '${color}')"
                                         data-color="${color}">
                                    </div>
                                `).join('')}
                            </div>
                            <input type="hidden" name="color" value="${colors[0]}">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Crea</button>
                            <button type="button" class="btn btn-secondary" onclick="app.ui.closeModal()" style="flex: 1;">Annulla</button>
                        </div>
                    </form>
                `);
            }

            showNewTaskForm(listId) {
                this.showModal('Nuovo Task', `
                    <form onsubmit="app.ui.handleCreateTask(event, ${listId})">
                        <div class="form-group">
                            <label class="form-label">Titolo</label>
                            <input type="text" class="form-input" name="title" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dettagli (opzionale)</label>
                            <textarea class="form-textarea" name="details"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reminder</label>
                            <input type="datetime-local" class="form-input" name="reminder">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priorità</label>
                            <select class="form-select" name="priority">
                                <option value="low">Bassa priorità</option>
                                <option value="medium" selected>Media priorità</option>
                                <option value="high">Alta priorità</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ricorrenza</label>
                            <select class="form-select" name="recurring">
                                <option value="none">Nessuna</option>
                                <option value="daily">Giornaliera</option>
                                <option value="weekly">Settimanale</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Crea</button>
                            <button type="button" class="btn btn-secondary" onclick="app.ui.closeModal()" style="flex: 1;">Annulla</button>
                        </div>
                    </form>
                `);
            }

            showTaskComments(taskId) {
                let task = null;
                let listId = null;
                
                for (const list of app.data.state.lists) {
                    const foundTask = list.tasks.find(t => t.id === taskId);
                    if (foundTask) {
                        task = foundTask;
                        listId = list.id;
                        break;
                    }
                }
                
                if (!task) return;
                
                this.showModal(`Commenti - ${task.title}`, `
                    <div class="space-y-3 mb-4" style="max-height: 200px; overflow-y: auto;">
                        ${task.comments.map(comment => `
                            <div class="card" style="background: #f3f4f6; padding: 12px;">
                                <div class="text-sm mb-1" style="color: #6b7280;">
                                    ${comment.author} - ${new Date(comment.time).toLocaleString('it-IT')}
                                </div>
                                <div>${comment.text}</div>
                            </div>
                        `).join('')}
                        
                        ${task.comments.length === 0 ? '<p class="text-center" style="color: #6b7280; padding: 16px;">Nessun commento</p>' : ''}
                    </div>
                    
                    <form onsubmit="app.ui.handleAddComment(event, ${listId}, ${taskId})">
                        <div class="flex gap-2">
                            <input type="text" class="form-input" name="comment" placeholder="Aggiungi commento..." required style="flex: 1;">
                            <button type="submit" class="btn btn-primary">Invia</button>
                        </div>
                    </form>
                `);
            }

            showStats() {
                this.showModal('Statistiche Produttività', `
                    <div class="space-y-3">
                        <div class="grid-2x2">
                            <div class="stat-card stat-blue">
                                <div class="stat-number">${app.data.state.stats.today}</div>
                                <div class="stat-label">Task Oggi</div>
                            </div>
                            <div class="stat-card stat-green">
                                <div class="stat-number">${app.data.state.stats.week}</div>
                                <div class="stat-label">Settimana</div>
                            </div>
                            <div class="stat-card stat-purple">
                                <div class="stat-number">${app.data.state.stats.month}</div>
                                <div class="stat-label">Mese</div>
                            </div>
                            <div class="stat-card" style="background: #fef3c7;">
                                <div class="stat-number" style="color: #92400e;">${app.data.state.stats.streak}</div>
                                <div class="stat-label">Streak giorni</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Produttività:</span>
                                <span class="font-semibold">${app.data.state.stats.productivity}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${app.data.state.stats.productivity}%"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Tempo oggi:</span>
                                <span class="font-semibold">${Math.floor(app.data.state.stats.timeSpentToday / 60)}h ${app.data.state.stats.timeSpentToday % 60}m</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tempo medio per task:</span>
                                <span class="font-semibold">${app.data.state.stats.avgTaskTime} min</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Task completati totali:</span>
                                <span class="font-semibold">${app.data.state.stats.totalCompleted}</span>
                            </div>
                        </div>
                    </div>
                `);
            }

            showCalendar() {
                this.showModal('Calendario Oggi', `
                    <div class="space-y-3">
                        ${app.data.state.calendarEvents.map(event => `
                            <div class="card">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>📅</span>
                                    <span class="font-medium">${event.title}</span>
                                </div>
                                <div class="text-sm" style="color: #6b7280;">
                                    ${event.time} - ${new Date(event.date).toLocaleDateString('it-IT')}
                                </div>
                            </div>
                        `).join('')}
                        
                        ${app.data.state.calendarEvents.length === 0 ? '<p class="text-center" style="color: #6b7280; padding: 16px;">Nessun evento oggi</p>' : ''}
                    </div>
                `);
            }

            showSettings() {
                const syncStatus = app.github.isConfigured ? 
                    `<div class="card" style="background: #d1fae5; border-color: #10b981; padding: 12px;">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 style="color: #047857; margin-bottom: 4px;">✅ GitHub Connesso</h4>
                                <p style="color: #059669; font-size: 12px;">Repository: ${app.github.username}/${app.github.repo}</p>
                                ${app.github.lastSync ? `<p style="color: #059669; font-size: 12px;">Ultimo sync: ${new Date(app.github.lastSync).toLocaleString('it-IT')}</p>` : ''}
                            </div>
                            <div class="flex gap-1">
                                <button class="btn btn-secondary" onclick="app.ui.performManualSync('auto')" style="font-size: 12px; padding: 6px 12px;">
                                    🔄 Sync
                                </button>
                                <button class="btn btn-warning" onclick="app.ui.disconnectGitHub()" style="font-size: 12px; padding: 6px 12px;">
                                    🔌 Disconnetti
                                </button>
                            </div>
                        </div>
                    </div>` :
                    `<div class="card" style="background: #fef3c7; border-color: #f59e0b; padding: 12px;">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 style="color: #92400e; margin-bottom: 4px;">⚠️ Sincronizzazione Offline</h4>
                                <p style="color: #d97706; font-size: 12px;">I dati sono salvati solo localmente</p>
                            </div>
                            <button class="btn btn-primary" onclick="app.ui.showGitHubSetup()" style="font-size: 12px; padding: 6px 12px;">
                                🔗 Configura GitHub
                            </button>
                        </div>
                    </div>`;

                this.showModal('Impostazioni', `
                    <div class="space-y-4">
                        ${syncStatus}
                        
                        <div>
                            <label class="form-label">Tema</label>
                            <div class="flex gap-2">
                                <button class="btn ${app.data.state.theme === 'light' ? 'btn-primary' : 'btn-secondary'}" onclick="app.ui.setTheme('light')">
                                    ☀️ Chiaro
                                </button>
                                <button class="btn ${app.data.state.theme === 'dark' ? 'btn-primary' : 'btn-secondary'}" onclick="app.ui.setTheme('dark')">
                                    🌙 Scuro
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="form-label">Suoni</label>
                            <div class="flex items-center gap-2 mb-2">
                                <button class="btn ${app.data.state.soundEnabled ? 'btn-success' : 'btn-secondary'}" onclick="app.ui.toggleSound()">
                                    ${app.data.state.soundEnabled ? '🔊' : '🔇'} ${app.data.state.soundEnabled ? 'Abilitati' : 'Disabilitati'}
                                </button>
                            </div>
                            
                            ${app.data.state.soundEnabled ? `
                                <select class="form-select" onchange="app.ui.setSoundType(this.value)">
                                    <option value="ding" ${app.data.state.selectedSound === 'ding' ? 'selected' : ''}>🔔 Ding</option>
                                    <option value="chime" ${app.data.state.selectedSound === 'chime' ? 'selected' : ''}>🎵 Chime</option>
                                    <option value="bell" ${app.data.state.selectedSound === 'bell' ? 'selected' : ''}>🔊 Bell</option>
                                    <option value="none" ${app.data.state.selectedSound === 'none' ? 'selected' : ''}>🔇 Silenzioso</option>
                                </select>
                            ` : ''}
                        </div>
                        
                        <button class="btn btn-primary" onclick="app.utils.playSound()" style="width: 100%;">
                            🔊 Test Suono
                        </button>
                    </div>
                `);
            }

            showGitHubSetup() {
                this.showModal('Configurazione GitHub', `
                    <div class="space-y-4">
                        <div class="card" style="background: #eff6ff; border-color: #93c5fd; padding: 12px;">
                            <h4 style="color: #1d4ed8; margin-bottom: 8px;">📋 Istruzioni Setup</h4>
                            <ol style="font-size: 13px; color: #1e40af; line-height: 1.4; margin-left: 16px;">
                                <li>Vai su <strong>GitHub.com</strong> e accedi</li>
                                <li>Crea un <strong>repository pubblico</strong> (es: "task-manager-data")</li>
                                <li>Vai su <strong>Settings > Developer settings > Personal access tokens > Tokens (classic)</strong></li>
                                <li>Clicca <strong>"Generate new token (classic)"</strong></li>
                                <li>Seleziona scopes: <strong>"repo"</strong> (Full repository access)</li>
                                <li>Copia il token generato</li>
                            </ol>
                        </div>

                        <form onsubmit="app.ui.handleGitHubSetup(event)">
                            <div class="form-group">
                                <label class="form-label">Username GitHub</label>
                                <input type="text" class="form-input" name="username" placeholder="il-tuo-username" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nome Repository</label>
                                <input type="text" class="form-input" name="repo" placeholder="task-manager-data" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Token di Accesso</label>
                                <input type="password" class="form-input" name="token" placeholder="ghp_xxxxxxxxxxxxxxxx" required>
                                <small style="color: #6b7280; font-size: 12px;">Il token non verrà mai condiviso</small>
                            </div>
                            
                            <div class="flex gap-2">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    🔗 Connetti GitHub
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="app.ui.closeModal()">
                                    Annulla
                                </button>
                            </div>
                        </form>
                    </div>
                `);
            }

            // Event Handlers
            handleCreateList(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                app.data.createList(formData.get('name'), formData.get('color'));
                this.closeModal();
                this.render();
            }

            handleCreateTask(event, listId) {
                event.preventDefault();
                const formData = new FormData(event.target);
                
                const taskData = {
                    title: formData.get('title'),
                    details: formData.get('details'),
                    reminder: formData.get('reminder'),
                    priority: formData.get('priority'),
                    recurring: formData.get('recurring') !== 'none' ? { 
                        type: formData.get('recurring'), 
                        nextDue: formData.get('reminder') 
                    } : null
                };
                
                app.data.createTask(listId, taskData);
                this.closeModal();
                this.render();
            }

            handleAddComment(event, listId, taskId) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const commentText = formData.get('comment');
                
                if (!commentText.trim()) return;
                
                app.data.addComment(listId, taskId, commentText);
                this.showTaskComments(taskId);
            }

            async handleGitHubSetup(event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                
                const username = formData.get('username').trim();
                const repo = formData.get('repo').trim();
                const token = formData.get('token').trim();

                if (!username || !repo || !token) {
                    alert('⚠️ Tutti i campi sono obbligatori');
                    return;
                }

                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '🔄 Connessione...';
                submitBtn.disabled = true;

                try {
                    const result = await app.github.configure(username, token, repo);
                    
                    if (result.success) {
                        alert('✅ ' + result.message);
                        this.closeModal();
                        app.github.hideSetupBanner();
                    } else {
                        alert('❌ ' + result.message);
                    }
                } catch (error) {
                    alert('❌ Errore di configurazione: ' + error.message);
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }

            handleSyncStatusClick() {
                if (!app.github.isConfigured) {
                    this.showGitHubSetup();
                    return;
                }
                
                this.showModal('Sincronizzazione GitHub', `
                    <div class="space-y-3">
                        <div class="card" style="background: #f3f4f6; padding: 12px;">
                            <div class="flex items-center justify-between mb-2">
                                <strong>Repository:</strong>
                                <span>${app.github.username}/${app.github.repo}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <strong>Ultimo sync:</strong>
                                <span>${app.github.lastSync ? new Date(app.github.lastSync).toLocaleString('it-IT') : 'Mai'}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="app.ui.performManualSync('upload')" style="flex: 1;">
                                ⬆️ Carica
                            </button>
                            <button class="btn btn-secondary" onclick="app.ui.performManualSync('download')" style="flex: 1;">
                                ⬇️ Scarica
                            </button>
                        </div>
                        
                        <button class="btn btn-success" onclick="app.ui.performManualSync('auto')" style="width: 100%;">
                            🔄 Sincronizzazione Automatica
                        </button>
                    </div>
                `);
            }

            async performManualSync(type) {
                this.closeModal();
                
                if (type === 'upload') {
                    await app.github.syncToCloud(true);
                } else if (type === 'download') {
                    await app.github.loadFromCloud(true);
                } else if (type === 'auto') {
                    const downloadResult = await app.github.loadFromCloud(true);
                    if (downloadResult.success && !downloadResult.updated) {
                        await app.github.syncToCloud(true);
                    }
                }
            }

            disconnectGitHub() {
                if (confirm('Vuoi disconnettere GitHub? I dati rimarranno solo in locale.')) {
                    app.github.disconnect();
                    this.showSettings();
                }
            }

            selectColor(element, color) {
                element.parentElement.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                element.classList.add('selected');
                element.parentElement.parentElement.querySelector('input[name="color"]').value = color;
            }

            setTheme(theme) {
                app.data.state.theme = theme;
                document.body.className = theme === 'dark' ? 'dark' : '';
                app.data.saveAndSync();
                this.showSettings();
            }

            toggleSound() {
                app.data.state.soundEnabled = !app.data.state.soundEnabled;
                app.data.saveAndSync();
                this.showSettings();
            }

            setSoundType(soundType) {
                app.data.state.selectedSound = soundType;
                app.data.saveAndSync();
            }
        }

        // === MODULO UTILITIES ===
        class Utils {
            playSound() {
                if (!app.data.state.soundEnabled || app.data.state.selectedSound === 'none') return;
                
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    const frequencies = {
                        ding: 800,
                        chime: 523,
                        bell: 440
                    };
                    
                    oscillator.frequency.setValueAtTime(frequencies[app.data.state.selectedSound] || 800, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }
        }

        // === MAIN APP ===
        class TaskManagerApp {
            constructor() {
                this.data = new DataManager();
                this.github = new GitHubSync();
                this.ui = new UIManager();
                this.utils = new Utils();
            }

            async init() {
                console.log('🚀 Inizializzazione app modulare...');
                
                const dataLoaded = this.data.loadFromLocal();
                if (dataLoaded) {
                    console.log('✅ Dati locali caricati');
                } else {
                    console.log('🆕 Prima volta - usando dati predefiniti');
                }
                
                if (this.data.state.theme === 'dark') {
                    document.body.className = 'dark';
                }
                
                const setupBannerDismissed = localStorage.getItem('setupBannerDismissed');
                if (setupBannerDismissed === 'true' || this.github.isConfigured) {
                    this.github.hideSetupBanner();
                } else {
                    this.github.showSetupBanner();
                }
                
                if (this.github.isConfigured) {
                    this.github.loadFromCloud(true).then(result => {
                        if (result && result.updated) {
                            console.log('🔄 Dati aggiornati dal cloud all\'avvio');
                        }
                    });
                    this.github.startAutoSync();
                }
                
                this.ui.render();
                
                // Event listeners
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.github.isConfigured) {
                        console.log('🔄 Pagina tornata visibile - controllo sync...');
                        this.github.loadFromCloud(false);
                    }
                });

                window.addEventListener('beforeunload', () => {
                    if (this.github.isConfigured && !this.github.isSyncing) {
                        this.github.syncToCloud(false);
                    }
                });
                
                console.log('🎉 App modulare inizializzata con successo!');
            }
        }

        // Initialize global app instance
        window.app = new TaskManagerApp();

        // Start app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>